# Creates a GitHub Release.
# Workflow is manually run.
# Preselect branch or tag before running this workflow.
name: github-release

on:
  workflow_dispatch:
    inputs:
      prerelease:
        description: "Indicator of whether or not is a prerelease"
        required: false
        default: false
        type: boolean
      generate-release-notes:
        description: "Whether to automatically generate the name and body for this release. If name is specified, the specified name will be used; otherwise, a name will be automatically generated. If body is specified, the body will be pre-pended to the automatically generated notes. See the GitHub docs for this feature for more information"
        required: true
        default: true
        type: boolean
      body:
        description: "Text communicating notable changes in this release. Prepends generated release notes."
        required: false
        type: string
      make-latest:
        description: "Specifies whether this release should be set as the latest release for the repository. Drafts and prereleases cannot be set as latest. Can be true, false, or legacy. Uses GitHub api defaults if not provided"
        required: true
        default: 'true'
        type: choice
        options:
          - 'true'
          - 'false'
          - legacy

permissions:
  contents: write

jobs:
  build:
    uses: ./.github/workflows/build.yml

  release:
    runs-on: ubuntu-latest
    needs:
    - build-other
    - build-linux
    - build-darwin
    - build-docker
    - build-ubi
    steps:
      - uses: actions/checkout@v4
      - uses: actions/download-artifact@v4
        with:
          path: openbao
          pattern: openbao_*'.'(zip || docker'.'tar)
      - uses: softprops/action-gh-release@v2
        if: startsWith(github.ref, 'refs/tags/')
        with:
          body: ${{ inputs.body }}
          files: openbao/*
          generate_release_notes: ${{ inputs.generate-release-notes }}
          make_latest: ${{ inputs.make-latest }}
          prerelease: ${{ inputs.prerelease }}
